<!-- map.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Safety Map - VigilanceHub{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        border-radius: 10px;
        background-color: var(--dark-card);
    }
    
    .leaflet-container {
        background-color: var(--dark-card) !important;
    }
    
    .leaflet-tile {
        filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(0.9);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="fw-bold">
            <i class="bi bi-map"></i> Safety Map
        </h1>
        <p class="text-muted">Interactive map showing reported incidents and safety zones in your area.</p>
    </div>
</div>

<div class="row">
    <!-- Map Controls -->
    <div class="col-md-3 mb-4">
        <div class="card border-0 h-100">
            <div class="card-header gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-sliders"></i> Map Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Filter by Severity</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="critical" checked>
                        <label class="form-check-label" for="critical" style="color: var(--danger);">
                            <i class="bi bi-circle-fill"></i> Critical
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="high" checked>
                        <label class="form-check-label" for="high" style="color: var(--warning);">
                            <i class="bi bi-circle-fill"></i> High
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="medium" checked>
                        <label class="form-check-label" for="medium" style="color: var(--info);">
                            <i class="bi bi-circle-fill"></i> Medium
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="low" checked>
                        <label class="form-check-label" for="low" style="color: var(--success);">
                            <i class="bi bi-circle-fill"></i> Low
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Incident Types</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="crime" checked>
                        <label class="form-check-label" for="crime">
                            <i class="bi bi-shield-exclamation"></i> Crime
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="accident" checked>
                        <label class="form-check-label" for="accident">
                            <i class="bi bi-car-front"></i> Accidents
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="hazard" checked>
                        <label class="form-check-label" for="hazard">
                            <i class="bi bi-triangle"></i> Hazards
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkpoint" checked>
                        <label class="form-check-label" for="checkpoint">
                            <i class="bi bi-shield-check"></i> Checkpoints
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Time Range</label>
                    <select class="form-select" id="time_range">
                        <option value="24">Last 24 Hours</option>
                        <option value="168" selected>Last 7 Days</option>
                        <option value="720">Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="use_location">
                        <i class="bi bi-geo-alt"></i> Use My Location
                    </button>
                    <button class="btn btn-outline-primary" id="refresh_map">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Map
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map -->
    <div class="col-md-9">
        <div class="card border-0">
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
            <div class="card-footer border-0" style="background-color: var(--dark-card);">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle text-primary me-2"></i>
                            <small class="text-muted">
                                Click on markers for details. Red areas indicate higher risk.
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#legendModal">
                            <i class="bi bi-list"></i> Show Legend
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="row mt-4">
            <div class="col-md-4 mb-3">
                <div class="card border-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="gradient-danger rounded p-3 me-3">
                                <i class="bi bi-exclamation-triangle fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">15</h5>
                                <small class="text-muted">Incidents in View</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="gradient-warning rounded p-3 me-3">
                                <i class="bi bi-thermometer-half fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">3</h5>
                                <small class="text-muted">High Risk Areas</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-0">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="gradient-success rounded p-3 me-3">
                                <i class="bi bi-shield-check fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-0">8</h5>
                                <small class="text-muted">Verified Reports</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Legend Modal -->
<div class="modal fade" id="legendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header" style="background-color: var(--dark-card);">
                <h5 class="modal-title">
                    <i class="bi bi-list"></i> Map Legend
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="background-color: var(--dark-card);">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-circle-fill me-2" style="color: var(--danger);"></i>
                            <div>
                                <strong>Critical</strong>
                                <p class="mb-0 text-muted">Emergency situations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-circle-fill me-2" style="color: var(--warning);"></i>
                            <div>
                                <strong>High Risk</strong>
                                <p class="mb-0 text-muted">Dangerous incidents</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-circle-fill me-2" style="color: var(--info);"></i>
                            <div>
                                <strong>Medium Risk</strong>
                                <p class="mb-0 text-muted">Caution advised</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-circle-fill me-2" style="color: var(--success);"></i>
                            <div>
                                <strong>Low Risk</strong>
                                <p class="mb-0 text-muted">Minor incidents</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Map initialization
    var map = L.map('map').setView([-1.2921, 36.8219], 12); // Nairobi

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Backend data
    var incidents = {{ incident_markers|safe }};
    var services  = {{ service_markers|safe }};

    // Incident markers
    incidents.forEach(function (incident) {
        var color =
            incident.severity === "critical" ? "#ff006e" :
            incident.severity === "high"     ? "#ffbe0b" :
            incident.severity === "medium"   ? "#00bbf9" :
                "#38b000";

        var marker = L.marker([incident.lat, incident.lng], {
            icon: L.divIcon({
                html: `<i class="bi bi-exclamation-triangle"
                          style="color:${color}; font-size:24px;"></i>`,
                iconSize: [24, 24],
                className: "map-marker"
            })
        }).addTo(map);

        marker.bindPopup(`
            <div style="background:var(--dark-card); color:var(--light-text); padding:10px; border-radius:6px;">
                <strong>${incident.title}</strong><br>
                <small>Severity: ${incident.severity}</small><br>
                <a href="/incidents/${incident.id}/"
                   class="btn btn-sm btn-primary mt-2">
                    View Details
                </a>
            </div>
        `);
    });

    /* ===============================
       Emergency services markers
    =============================== */
    services.forEach(function (service) {
        var icon =
            service.type === "police"   ? "bi-shield-check" :
            service.type === "hospital" ? "bi-hospital" :
            service.type === "fire"     ? "bi-fire" :
                "bi-geo-alt";

        var color =
            service.type === "police"   ? "#0d6efd" :
            service.type === "hospital" ? "#dc3545" :
            service.type === "fire"     ? "#ffc107" :
                "#6c757d";

        var marker = L.marker([service.lat, service.lng], {
            icon: L.divIcon({
                html: `<i class="bi ${icon}" style="color:${color}; font-size:22px;"></i>`,
                iconSize: [22, 22],
                className: "map-marker"
            })
        }).addTo(map);

        marker.bindPopup(`
            <div style="background:var(--dark-card); color:var(--light-text); padding:10px; border-radius:6px;">
                <strong>${service.name}</strong><br>
                <small>${service.type.toUpperCase()}</small><br>
                ${service.phone
                    ? `<a href="tel:${service.phone}" class="btn btn-sm btn-outline-primary mt-2">Call</a>`
                    : ""}
            </div>
        `);
    });

    /* ===============================
       User location
    =============================== */
    var locationBtn = document.getElementById("use_location");

    if (locationBtn) {
        locationBtn.addEventListener("click", function () {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                return;
            }

            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                map.setView([lat, lng], 14);

                L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: `<i class="bi bi-person-circle"
                                  style="color:var(--primary);
                                         font-size:24px;"></i>`,
                        iconSize: [24, 24]
                    })
                }).addTo(map).bindPopup("Your Location");
            });
        });
    }
</script>
{% endblock %}
